source_if_exists() {
    [ -r $1 ] && source $1
}

# Start p10k instant prompt
source_if_exists "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"

# Configure misc
setopt auto_cd
setopt auto_pushd
setopt pushd_ignore_dups
setopt pushd_minus
setopt interactive_comments
setopt multios
setopt ksh_option_print

# Configure history
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_verify
setopt share_history
HISTFILE="$HOME/.zsh_history"
HISTSIZE=50000
SAVEHIST=10000

source "$HOME/.zinit/bin/zinit.zsh"
zinit for \
    OMZL::completion.zsh \
    OMZL::key-bindings.zsh \
    OMZL::clipboard.zsh \
    OMZP::sudo \
    OMZP::systemd \
    https://github.com/junegunn/fzf/blob/master/shell/key-bindings.zsh
zinit svn for \
    OMZP::extract \
    OMZP::pip
zinit as"completion" for \
    OMZP::ripgrep/_ripgrep \
    OMZP::cargo/_cargo \
    OMZP::rust/_rust \
    OMZP::rustup/_rustup \
    OMZP::docker/_docker \
    OMZP::docker-compose/_docker-compose
zinit light-mode depth"1" for \
    romkatv/powerlevel10k \
    Aloxaf/fzf-tab \
    zdharma/fast-syntax-highlighting \
    zsh-users/zsh-autosuggestions \
    zsh-users/zsh-history-substring-search \
    MichaelAquilina/zsh-you-should-use \
    hlissner/zsh-autopair
zicompinit
zicdreplay

# Configure fzf
export FZF_DEFAULT_OPTS="--ansi --layout=reverse --bind=tab:accept"

# Configure fzf-tab
# zstyle ':fzf-tab:*' fzf-command ftb-tmux-popup  # wait for tmux 3.2
zstyle ':fzf-tab:*' fzf-bindings 'tab:accept'
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-preview 'ps --pid=$word -o cmd --no-headers -w -w'
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-flags '--preview-window=down:3:wrap'
zstyle ':fzf-tab:complete:kill:*' popup-pad 0 3
zstyle ':completion:*:git-checkout:*' sort false

# Configure bat
export BAT_THEME="OneHalfDark"

# Configure man-pages
export MANPAGER="sh -c 'col -bx | bat -l man -p --theme=\"Monokai Extended\"'"
export MANROFFOPT="-c"

# Aliases
unalias zi zini zpl zplg
alias -g ...="../.."
alias -g ....="../../.."
alias -g .....="../../../.."
alias :q="exit"
alias l="exa -lah --group-directories-first --git --time-style=long-iso"
alias pc="proxychains -q "
alias clc="clipcopy"
alias clp="clippaste"
alias sudo="sudo "
alias with-proxy=' \
    TMP_PROXY=127.0.0.1:1999 \
    http_proxy=$TMP_PROXY \
    HTTP_PROXY=$TMP_PROXY \
    https_proxy=$TMP_PROXY \
    HTTPS_PROXY=$TMP_PROXY '

source_if_exists "/usr/share/nnn/quitcd/quitcd.bash_zsh"
source_if_exists "$HOME/.cargo/env"
source_if_exists "$HOME/.opam/opam-init/init.zsh"
source_if_exists "$HOME/.p10k.zsh"

export EDITOR="vim"

export path=(
    "$HOME/.ghcup/bin"
    $path
)

# Directory shortcuts
hash -d Downloads="$HOME/Downloads"
hash -d Workspace="$HOME/Workspace"
hash -d Temp="$HOME/Workspace/Code/Temp"
hash -d QuarticCat="$HOME/Workspace/Code/QuarticCat"
hash -d Homework="$HOME/Workspace/Homework"

# My functions
git-stats() {  # too hard to write it as a git alias
    git log --format='%aN' | \
    sort -u | \
    while read name; do
        echo -e "$name:"
        git log --author="$name" --pretty=tformat: --numstat | \
        awk '{ add += $1; subs += $2; loc += $1 - $2 } END { printf "  + %s\n  - %s\n  = %s\n", add, subs, loc }' -
    done
}
